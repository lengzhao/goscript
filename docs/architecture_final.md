# GoScript 最终架构设计

## 1. 概述

本文档描述了GoScript的最终架构设计，该设计经过优化和清理，提供了一个简洁、高效且易于维护的脚本引擎实现。

## 2. 核心设计理念

### 2.1 利用Go标准库
GoScript充分利用Go标准库的功能，特别是`context`包来管理执行上下文和变量作用域。

### 2.2 简化操作码设计
通过简化操作码设计，减少虚拟机的复杂性，提高执行效率。

### 2.3 模块化架构
采用模块化设计，各个组件职责清晰，便于维护和扩展。

## 3. 核心组件

### 3.1 类型系统 (types)
类型系统定义了GoScript中所有类型都需要实现的`IType`接口，以及基本类型的实现。

**主要文件**：
- `types/types.go` - 定义`IType`接口和基本类型

**关键特性**：
- 统一的类型管理体系
- 支持基本类型（int, float64, string, bool）
- 可扩展的类型系统

### 3.2 符号表 (symbol)
符号表用于管理变量、函数、类型等符号信息，支持作用域嵌套和模块化管理。

**主要文件**：
- `symbol/symbol.go` - 符号和符号表的实现

**关键特性**：
- 支持作用域嵌套
- 模块化符号管理
- 高效的符号查找

### 3.3 虚拟机 (vm)
虚拟机负责执行编译后的字节码指令，定义了简化后的操作码和指令格式。

**主要文件**：
- `vm/opcodes.go` - 操作码和指令定义
- `vm/vm.go` - 虚拟机实现

**关键特性**：
- 简化的操作码设计（仅10个核心操作码）
- 基于栈的指令执行
- 内置的错误处理机制

### 3.4 执行上下文 (context)
执行上下文管理脚本执行时的变量作用域、安全控制和生命周期管理。

**主要文件**：
- `context/execution.go` - 执行上下文实现
- `context/scope_manager.go` - 作用域管理

**关键特性**：
- 利用Go的`context`包管理作用域和生命周期
- 内置的安全控制机制（超时、内存限制等）
- 自然的变量查找链

### 3.5 模块管理 (module)
模块管理器负责管理不同的模块，支持模块间调用和函数注册。

**主要文件**：
- `module/manager.go` - 模块和模块管理器实现

**关键特性**：
- 模块化函数管理
- 内置模块支持（math, fmt等）
- 模块访问控制

### 3.6 运行时 (runtime)
运行时提供脚本执行环境，管理变量、函数、类型和模块。

**主要文件**：
- `runtime/runtime.go` - 运行时环境实现

**关键特性**：
- 变量管理
- 函数注册和调用
- 类型系统支持

### 3.7 词法分析器 (lexer)
词法分析器将源代码转换为词法标记(tokens)。

**主要文件**：
- `lexer/lexer.go` - 词法分析器实现

**关键特性**：
- 复用Go标准库的`go/scanner`
- 支持Go标准语法标记
- 高效的标记生成

### 3.8 语法分析器 (parser)
语法分析器将词法标记转换为抽象语法树(AST)。

**主要文件**：
- `parser/parser.go` - 语法分析器实现

**关键特性**：
- 复用Go标准库的`go/parser`
- 生成兼容的AST
- 支持Go标准语法规则

### 3.9 抽象语法树 (ast)
抽象语法树表示源代码的结构化形式。

**主要文件**：
- `ast/ast.go` - AST节点定义

**关键特性**：
- 复用Go标准库的`go/ast`
- 便于遍历和操作的节点结构
- 与Go标准库兼容

## 4. 执行流程

```
+-----------------+      +-----------------+
|   Source Code   | ---> |     Lexer       |
+-----------------+      +-----------------+
                                |
                                v
+-----------------+      +-----------------+
|    Parser       | <--- |    Tokens       |
+-----------------+      +-----------------+
        |
        v
+-----------------+      +-----------------+
|      AST        | ---> |   Compiler      |
+-----------------+      +-----------------+
                                |
                                v
+-----------------+      +-----------------+
|   Bytecode      | <--- |   Constants     |
+-----------------+      +-----------------+
        |
        v
+-----------------+      +-----------------+
|      VM         | ---> |    Result       |
+-----------------+      +-----------------+
```

1. **词法分析**：源代码 → Tokens
2. **语法分析**：Tokens → AST
3. **编译**：AST → 字节码指令和常量池
4. **执行**：
   - 创建执行上下文
   - 加载模块和函数
   - 执行字节码指令
   - 管理作用域和变量

## 5. 作用域管理

通过Go的`context`包实现自然的作用域管理：

### 5.1 作用域嵌套
```
全局作用域
└── 模块作用域
    └── 函数作用域
        └── 块作用域
```

### 5.2 变量查找
利用`context`的值机制实现自然的变量查找链，从当前作用域向上查找直到全局作用域。

### 5.3 变量隔离
不同作用域之间的变量自然隔离，防止变量污染。

## 6. 模块系统

模块系统支持：

1. **模块定义和注册**：创建和注册自定义模块
2. **函数注册**：在模块中注册函数
3. **模块间调用**：支持跨模块函数调用
4. **内置模块**：提供常用的内置模块（math, fmt等）
5. **访问控制**：控制模块的访问权限

## 7. 安全机制

安全机制包括：

1. **执行时间限制**：通过`context.WithTimeout`实现
2. **内存使用限制**：通过安全上下文控制
3. **模块访问控制**：控制可访问的模块
4. **关键字禁用**：禁止危险关键字（如unsafe）

## 8. 扩展机制

扩展机制支持：

1. **自定义函数**：注册自定义Go函数
2. **自定义类型**：实现`IType`接口定义新类型
3. **模块扩展**：创建自定义模块
4. **安全策略**：自定义安全控制策略

## 9. 性能优化

### 9.1 操作码优化
通过简化操作码设计，减少虚拟机的复杂性，提高执行效率。

### 9.2 作用域管理优化
利用Go的`context`包优化作用域管理，减少内存分配和查找时间。

### 9.3 标准库复用
复用Go标准库的词法分析、语法分析和AST处理功能，确保兼容性和性能。

## 10. 总结

GoScript的最终架构设计通过以下方式实现了简洁、高效和安全的脚本引擎：

1. **利用Go标准库**：复用成熟的Go标准库功能
2. **简化设计**：通过简化操作码和组件设计降低复杂性
3. **自然的作用域管理**：利用Go的`context`包实现自然的作用域管理
4. **模块化架构**：清晰的组件职责划分便于维护和扩展
5. **内置安全机制**：提供多层次的安全控制

这种设计使得GoScript成为一个易于使用、高性能且安全的脚本引擎，适用于各种Go应用程序的动态执行需求。