# GoScript 架构设计

## 1. 概述

GoScript是一个兼容Go标准语法的脚本引擎，它允许你在Go应用程序中动态执行Go代码。本文档详细描述了GoScript的架构设计和各个组件的职责。

## 2. 核心组件

### 2.1 类型系统 (types)

类型系统定义了GoScript中所有类型都需要实现的[IType](../types/types.go#L10-L15)接口，以及基本类型的实现。

主要文件：
- [types.go](../types/types.go) - 定义[IType](../types/types.go#L10-L15)接口和基本类型

### 2.2 符号表 (symbol)

符号表用于管理变量、函数、类型等符号信息，支持作用域嵌套和模块化管理。

主要文件：
- [symbol.go](../symbol/symbol.go) - 符号和符号表的实现

### 2.3 虚拟机 (vm)

虚拟机负责执行编译后的字节码指令，定义了操作码和指令格式。

主要文件：
- [opcodes.go](../vm/opcodes.go) - 操作码和指令定义

### 2.4 执行上下文 (context)

执行上下文管理脚本执行时的变量作用域、栈和模块信息。

主要文件：
- [execution.go](../context/execution.go) - 执行上下文实现
- [scope_manager.go](../context/scope_manager.go) - 作用域管理

### 2.5 模块管理 (module)

模块管理器负责管理不同的模块，支持模块间调用和指令集隔离。

主要文件：
- [manager.go](../module/manager.go) - 模块和模块管理器实现

### 2.6 运行时 (runtime)

运行时提供脚本执行环境，管理变量、函数、类型和模块。

主要文件：
- [runtime.go](../runtime/runtime.go) - 运行时环境实现

### 2.7 词法分析器 (lexer)

词法分析器将源代码转换为词法标记(tokens)。

主要文件：
- [lexer.go](../lexer/lexer.go) - 词法分析器实现

### 2.8 语法分析器 (parser)

语法分析器将词法标记转换为抽象语法树(AST)。

主要文件：
- [parser.go](../parser/parser.go) - 语法分析器实现

### 2.9 抽象语法树 (ast)

抽象语法树表示源代码的结构化形式。

主要文件：
- [ast.go](../ast/ast.go) - AST节点定义

## 3. 执行流程

1. **词法分析**：源代码 → Tokens
2. **语法分析**：Tokens → AST
3. **语义分析**：AST → 符号表
4. **编译**：AST → 字节码指令
5. **执行**：
   - 创建执行上下文
   - 加载模块
   - 执行字节码指令
   - 管理作用域和变量

## 4. 数据流

```
+-----------------+
|   Source Code   |
+-----------------+
        |
        v
+-----------------+
|     Lexer       |
+-----------------+
        |
        v
+-----------------+
|    Tokens       |
+-----------------+
        |
        v
+-----------------+
|    Parser       |
+-----------------+
        |
        v
+-----------------+
|      AST        |
+-----------------+
        |
        v
+-----------------+
|   Compiler      |
+-----------------+
        |
        v
+-----------------+
|   Bytecode      |
+-----------------+
        |
        v
+-----------------+
|      VM         |
+-----------------+
        |
        v
+-----------------+
|    Result       |
+-----------------+
```

## 5. 作用域管理

通过上下文层级实现作用域隔离：

1. 全局作用域
2. 模块作用域
3. 函数作用域
4. 块作用域

## 6. 模块系统

模块系统支持：

1. 模块定义和注册
2. 模块间调用
3. 指令集隔离
4. 符号导入/导出

## 7. 安全机制

安全机制包括：

1. 执行时间限制
2. 内存使用限制
3. 模块访问控制
4. 关键字禁用

## 8. 扩展机制

扩展机制支持：

1. 自定义函数
2. 自定义类型
3. 模块扩展